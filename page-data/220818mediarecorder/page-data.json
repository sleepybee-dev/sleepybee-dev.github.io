{"componentChunkName":"component---src-templates-post-jsx","path":"/220818mediarecorder/","result":{"data":{"site":{"siteMetadata":{"title":"sleepybee-dev-log"}},"markdownRemark":{"id":"8ee19a1b-baa8-5cdd-ab14-8508b81538e1","excerpt":"저장소 액세스 정책 변경 Android 10 이상을 타겟팅하는 기기부터 외부 저장소 루트는 아예 사용할 수가 없고 몇 가지 허용된 공간만 사용 가능합니다. 또, 사용 가능한 외부 저장소에 액세스할 경우에 SAF나 MediaStore를 사용하도록 강제되었습니다.  $card 이 저장소 정책이 적용된지는 한참 됐지만 MediaRecorder에서 약간 헤매게 …","html":"<h2>저장소 액세스 정책 변경</h2>\n<p>Android 10 이상을 타겟팅하는 기기부터 외부 저장소 루트는 아예 사용할 수가 없고 몇 가지 허용된 공간만 사용 가능합니다. 또, 사용 가능한 외부 저장소에 액세스할 경우에 SAF나 MediaStore를 사용하도록 강제되었습니다.<br>\n<a href=\"https://developer.android.com/training/data-storage/shared/media?hl=ko\">$card</a></p>\n<p>이 저장소 정책이 적용된지는 한참 됐지만 MediaRecorder에서 약간 헤매게 됐는데 솔루션이 있는 웹페이지가 없길래 정리해 둡니다.</p>\n<h2>MediaRecorder</h2>\n<p><div>\n      <a target=\"_blank\" rel=\"noopener noreferrer\" href=\"https://github.com\" class=\"preview-notion-container\">\n        <div class=\"preview-notion-wrapper\">\n          <div class=\"preview-notion-title\">Not Found Site</div>\n          <div class=\"preview-notion-description\">Cannot find site or meta tag and title.</div>\n          <div class=\"preview-notion-url\">\n            <img class=\"preview-notion-favicon\" src=\"data:image/png;base64,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\" alt=\"Not Found Site-favicon\"/>\n            <div class=\"preview-notion-link\">https://github.com</div>\n          </div>\n        </div>\n        <div class=\"preview-notion-image-wrapper\">\n          <img class=\"preview-notion-image\" alt=\"Not Found Site-image\" src=\"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGAAAABWCAMAAAAHZWO6AAAAKlBMVEXy8vLz8/P09PT19fX29vb39/f4+Pj5+fn6+vr7+/v8/Pz9/f3+/v7///8W37AjAAACRklEQVRo3u2Za3bEIAiFg8+ouP/t9kem0yQKomXanp5hAX4mXC6i2/YOYUDKurHfAAarbuTfAJSkFdgHRLWMpjfgDfg5ALgQgzevAphYaq21YrIvAbjyrHuMoA9wF3eK6gBTruYVtAH7zR2L0QXYxr6DLiC0Bg+qgNQA0GgCoAOwr/4CXcDeAIrqL9p8A0jMmQfmAfc6q9XTgJBgvtCiXKUO6w7zVpGvKXbk+rY0ZSgyO3v+SUjX8bGT6wZkdm2+pFroBMBDb8XONxzwCWutmAOj0GeuslnpycY5ZzkT8l+meEq0XtO/dKWoD7hWC3ptwN0Sn4lWAkBjWJ+JVgK0Tak+PEMH4HpDUdQD2NKbnI5EawBuXnU1rTUABMv21FNjWgOEs2VHer5MsAZweHIDz029O6wAjpxGRkCnM9oC4JHTQySm8EM4zs/Jz5yi654rZZN+FLj+cXrxqAw4L5ig7xLfAVxzukPP574DuOc0soU2D2jWQi9Q0gRg7/vNQEpyQCD8ZiAlMaBftGMpSQG2UH4zkJL0XJRJvxlISXhXQe9xJCUZIHKOxktJBOB1wktJAhiZZgLmIyXH9zzyG05KY8DQbT6llBcBUXB/zEhpCAhVEuioYh8BnPCynJTSAGCL9JadkhIPgFzFQUiJBYwb4lhKLCDMrE9IiQP4ydcQtB1VMAB5gjkp0QCT63R0pEQCJA4hkRIJiHUpGilRALv68GS2bTMhHlG4X7T4kvg3HihAKwgAFq3AX3rL1AXc1AJx142w/Zf4AH4Xp03JwAN4AAAAAElFTkSuQmCC\" />\n        </div>\n      </a>\n    </div></p>\n<p>시시콜콜한 것들은 도큐먼트에 잘 나와 있습니다.</p>\n<h2>외부저장소에 저장하기</h2>\n<pre><code class=\"language-java\">...\nrecorder = new MediaRecorder(); \nrecorder.setAudioSource(MediaRecorder.AudioSource.MIC); \nrecorder.setOutputFormat(MediaRecorder.OutputFormat.THREE_GPP); \nrecorder.setOutputFile(fileName);\n</code></pre>\n<p>여기서 <code>setOutputFile()</code>의 fileName은 저장하고자 하는 파일명의 full path만 사용하면 됐었습니다.\n이 함수는 내부 저장소(data/data/{app_name})에서는 고대로 사용할 수 있습니다.\n하지만 MediaStore로 접근해야 하는 외부 저장소를 사용할 때에는 더이상 String으로된 path로 접근할 수가 없습니다.</p>\n<p>그렇다면 outputFile의 Path를 어떻게 지정할 수 있을까?</p>\n<p><code>setOutputFile()</code>중에는 FileDescriptor를 파라미터로 갖는 것이 있습니다.</p>\n<p><img src=\"mediarecorder.png\"></p>\n<p>이렇게 FileDescriptor를 얻으면 되겠구나!</p>\n<pre><code class=\"language-java\">FileDescriptor getFileDescriptor(){\n\n    ContentValues values = new ContentValues();\n\n    values.put(MediaStore.Video.Media.DISPLAY_NAME, \"filename.MP4\");\n\n    values.put(MediaStore.Video.Media.MIME_TYPE, \"video/*\");\n\n    ContentResolver resolver = getContentResolver();\n\n    Uri item = contentResolver.insert(MediaStore.Video.Media.EXTERNAL_CONTENT_URI, values);\n\n    ParcelFileDescriptor fileDescriptor = null;\n\n    try {\n\n        fileDescriptor = resolver.openFileDescriptor(item, \"w\");\n\n        return fileDescriptor.getFileDescriptor();\n\n    } catch (FileNotFoundException e) {\n\n        e.printStackTrace();\n\n    }\n\n    return null;\n\n}\n</code></pre>\n<p>안됩니다.</p>\n<p>내부저장소는 full path만 넣으면 파일이 미리 만들어져 있지 않아도 그 위치에 그 파일명으로 write가 되었던 반면, 이렇게 할 때엔 내가 임시 파일을 생성해 두어야 합니다.  </p>\n<p>여기서 기존 코드랑 꼬였어서 조금 헤맸습니다.</p>\n<ul>\n<li>정상 예제</li>\n</ul>\n<pre><code class=\"language-java\">FileDescriptor getFileDescriptor() {\n\n    ContentValues values = new ContentValues();\n\n    values.put(MediaStore.Video.Media.DISPLAY_NAME, \"filename.MP4\");\n\n    values.put(MediaStore.Video.Media.MIME_TYPE, \"video/*\");\n\n    if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.Q) {\n\n        // 해당 파일을 다른 앱에서 접근하는 것을 막는 플래그.\n\n        values.put(MediaStore.Video.Media.IS_PENDING, 1);\n\n    }\n\n    ContentResolver resolver = getContentResolver();\n\n    Uri item = contentResolver.insert(MediaStore.Video.Media.EXTERNAL_CONTENT_URI, values);\n\n    ParcelFileDescriptor fileDescriptor = null;\n\n    try {\n\n        // file write 추가\n\n        fileDescriptor = resolver.openFileDescriptor(item, \"w\");\n\n        if (fileDescriptor != null) {\n\n        // 빈 파일 생성\n\n        String str = \"hello\";\n\n        byte[] strToByte = str.getBytes();\n\n        FileOutputStream fos = new FileOutputStream(fileDescriptor.getFileDescriptor());\n\n        fos.write(strToByte);\n\n        fos.close();\n\n        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.Q) {\n\n            values.clear();\n\n            // 해당 파일을 다른 앱에서 접근하는 것을 다시 허용.\n\n            values.put(MediaStore.Images.Media.IS_PENDING, 0);\n\n            contentResolver.update(item, values, null, null);\n\n        }\n\n        return fileDescriptor.getFileDescriptor();\n\n    } catch (FileNotFoundException e) {\n\n        e.printStackTrace();\n\n    }\n\n    return null;\n\n}\n</code></pre>\n<p>이제 Recording이 정상적으로 되는 것을 확인할 수 있습니다.</p>\n<p>서치하다가 못 찾고 궁리해낸 방법이라 제대로 된 솔루션이 따로 있을 수 있습니다.</p>\n<p>지적은 언제나 환영.</p>","frontmatter":{"title":"[해결] MediaRecorder에서 저장소 정책 변경 적용","date":"August 18, 2022","update":null,"tags":["SLtackOverFlow","Android"],"series":null},"fields":{"slug":"/220818mediarecorder/","readingTime":{"minutes":4.035}}},"seriesList":{"edges":[{"node":{"id":"33662c2c-29fd-5961-9f17-56ef6f5523f0","fields":{"slug":"/201006ptube/"},"frontmatter":{"title":"📼비공개 유튜브 채널 앱, 피튜브Ptube"}}},{"node":{"id":"d66b9a74-ac07-5ed6-a85c-daaa3f4c6d96","fields":{"slug":"/201202picshelf/"},"frontmatter":{"title":"🖼️사진 위젯 앱, 픽셀프Picshelf"}}},{"node":{"id":"ca8bfe95-74f3-54b5-92f8-b2e0ee7ec151","fields":{"slug":"/220327diamonddialfab/"},"frontmatter":{"title":"💠다이아몬드 다이얼 FAB 라이브러리"}}},{"node":{"id":"334b30d0-0086-59f7-84c2-638ec6aca270","fields":{"slug":"/220807obsidianblog/"},"frontmatter":{"title":"옵시디언 블로그 만들기"}}},{"node":{"id":"8f0c6fb5-a592-511e-bf32-3c5daf095f85","fields":{"slug":"/220811plibula/"},"frontmatter":{"title":"🎤플레이리스트를 노래방 번호로 바꿔주는 앱, 플리불러"}}},{"node":{"id":"8ee19a1b-baa8-5cdd-ab14-8508b81538e1","fields":{"slug":"/220818mediarecorder/"},"frontmatter":{"title":"[해결] MediaRecorder에서 저장소 정책 변경 적용"}}},{"node":{"id":"4b039cfb-43ba-5c40-b675-a5aa507a5dab","fields":{"slug":"/220819zolaseo/"},"frontmatter":{"title":"Zola 블로그 검색 노출 작업 (SEO)"}}},{"node":{"id":"5870c218-f18f-5670-8d49-731d9032198b","fields":{"slug":"/220902getxtwitter/"},"frontmatter":{"title":"시간을 되돌려 GetX가 만들어지는 걸 막고 싶다"}}},{"node":{"id":"f5d475c2-c0c2-57f0-84c5-a90fb5ba057f","fields":{"slug":"/221014slide/"},"frontmatter":{"title":"(슬라이드) Shallow Dive to Obsidian"}}},{"node":{"id":"7d289b78-cbf8-5b98-a156-6a5db6ca5ff7","fields":{"slug":"/221125boostcorse/"},"frontmatter":{"title":"데이터사이언스 부스트코스 회고"}}},{"node":{"id":"56804d93-fb54-5957-975b-719a27e9ef46","fields":{"slug":"/221217compose/"},"frontmatter":{"title":"Compose Camp 회고"}}},{"node":{"id":"cc33197a-f69a-54d4-9181-97b8c08c1160","fields":{"slug":"/230127wewish/"},"frontmatter":{"title":"🎁위시리스트 공유하는 앱, 위위시wewish"}}},{"node":{"id":"f8bb70d9-bfcb-5fa0-ac2f-d9cf463e770c","fields":{"slug":"/230207fluttersongdo/"},"frontmatter":{"title":"Flutter Songdo 스터디 회고"}}}]},"previous":{"fields":{"slug":"/220811plibula/"},"frontmatter":{"title":"🎤플레이리스트를 노래방 번호로 바꿔주는 앱, 플리불러"}},"next":{"fields":{"slug":"/220819zolaseo/"},"frontmatter":{"title":"Zola 블로그 검색 노출 작업 (SEO)"}}},"pageContext":{"id":"8ee19a1b-baa8-5cdd-ab14-8508b81538e1","series":null,"previousPostId":"8f0c6fb5-a592-511e-bf32-3c5daf095f85","nextPostId":"4b039cfb-43ba-5c40-b675-a5aa507a5dab"}},"staticQueryHashes":[],"slicesMap":{}}